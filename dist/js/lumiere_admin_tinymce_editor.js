!function(d){tinymce.create("tinymce.plugins.lumiere_link_maker",{extended_valid_elements:["+@[data-lum_link_maker]","+@[data-lum_movie_maker]"],init:function(n,e){var t=null,i=lumiere_admin_vars.wordpress_path+lumiere_admin_vars.gutenberg_search_url+"?moviesearched=",c='<img src="'+lumiere_admin_vars.imdb_path+'pics/lumiere-ico-noir13x13.png" class="lumiere_admin_tiny_img" width="13" />',a="lum_link_maker",r="<span data-"+a+'="popup">',o="lum_movie_maker",l='<span data-lum_movie_maker="',m=l+'movie_title">',u=l+'movie_id">';n.addButton("lumiere_tiny",{title:"Lumière! add info",image:lumiere_admin_vars.imdb_path+"pics/lumiere-ico-noir13x13.png",type:"menubutton",menu:[{text:"Add a popup link",onclick:function(){this.active(!this.active());this.active();var e=n.selection.getContent();n.windowManager.open({width:400,height:150,title:"Lumière! Add a link to a popup",body:[{type:"textbox",name:"textboxName",label:"Movie title",value:e}],onsubmit:function(e){!(target="")===e.data.blank&&(target+='newtab="on"'),n.insertContent(" "+r+e.data.textboxName+"</span> ")}})}},{text:"Add a movie section",onclick:function(){var e=n.selection.getContent(),t=e||"";n.windowManager.open({width:450,height:200,title:"Lumière! Add a movie section inside the post",body:[{type:"textbox",name:"movieReference",label:"Movie title/IMDb ID",value:e},{type:"listbox",name:"movieFormat",label:"My movie is inserted by:",values:[{text:"By title",value:"movie_title"},{text:"By id",value:"movie_id"}]},{type:"button",name:"IMDbID",label:"Find IMDb ID",text:"Open Search Window",onclick:function(){n.windowManager.open({title:"Internal Query to find IMDb ID",file:i+t,width:500,height:400,inline:1},{editor:n,jquery:d,valid_value:"value"})}}],onsubmit:function(e){!(target="")===e.data.blank&&(target+='newtab="on"'),n.insertContent(" "+l+e.data.movieFormat+'">'+e.data.movieReference+"</span> ")}})}},{text:"Find IMDb ID",onclick:function(){var e=n.selection.getContent();n.windowManager.open({title:"Internal Query to find IMDb ID",file:i+(e||""),width:500,height:400,inline:1},{editor:n,jquery:d,valid_value:"value"})}}],onPostRender:function(e){t=this},onclick:function(e){this.active(!this.active());this.active();old_text=n.selection.getContent(),new_text=old_text.replace(/<span data-lum_[^>]+>(.+)<\/span>/,"$1"),n.selection.setContent(new_text)}}),n.on("PostProcess",function(e){e.get&&(e.content=e.content.replace(/<img class="lumiere_admin_tiny_img"[^>]+>\s?\s?/g,""))}),n.on("BeforeSetContent",function(e){var t=c+"&nbsp;"+r,n=c+"&nbsp;"+m,i=c+"&nbsp;"+u,a=new RegExp("("+r+")","g"),o=new RegExp("("+m+")","g"),l=new RegExp("("+u+")","g");e.content=e.content.replace(a,t),e.content=e.content.replace(o,n),e.content=e.content.replace(l,i)}),n.on("click",function(e){click_popup=d(e.target).data(a),click_movie=d(e.target).data(o);e=t;click_popup&&e.active(e.active())||click_movie&&e.active(e.active())?e.active(e.active(!1)):e.active(e.active(!0))})},setup:function(e){e.on("NodeChanged",function(e,t){console.log("node changed"),e.setActive("lumiere_tiny","SPAN"===t.nodeName)})},createControl:function(e,t){return null},getInfo:function(){return{longname:"Lumière TinyMCE editor",author:"JCV",authorurl:"https://www.jcvignoli.com/blog",infourl:"https://www.jcvignoli.com/en/lumiere-movies-wordpress-plugin/",version:"4.0"}}}),tinymce.PluginManager.add("lumiere_tiny",tinymce.plugins.lumiere_link_maker)}(jQuery);